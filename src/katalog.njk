---
layout: layout.njk
title: Katalog
---

<section class="catalog-section content-offset">
    <div class="catalog-container">
        <h1 class="katalog-title">Istražite naš Katalog proizvoda</h1>

        <div class="catalog-layout">
            
            <aside class="filter-sidebar">
                <h2><i class="fas fa-filter"></i> Filteri</h2>
                
                <div class="filter-group">
                    <h3>Zapremina (Litara)</h3>
                    <div class="filter-options" id="filterZapremina">
                        <label class="filter-checkbox-label">
                            <input type="checkbox" name="zapremina" value="0-50"> Do 50 L
                        </label>
                        <label class="filter-checkbox-label">
                            <input type="checkbox" name="zapremina" value="51-100"> 51 - 100 L
                        </label>
                        <label class="filter-checkbox-label">
                            <input type="checkbox" name="zapremina" value="101-200"> 101 - 200 L
                        </label>
                    </div>
                </div>

                <div class="filter-group">
                    <h3>Snaga Grejača (W)</h3>
                    <div class="filter-options" id="filterSnaga">
                        <label class="filter-checkbox-label">
                            <input type="checkbox" name="snaga" value="1000-2000"> Do 2000 W
                        </label>
                        <label class="filter-checkbox-label">
                            <input type="checkbox" name="snaga" value="2001-3000"> 2001 - 3000 W
                        </label>
                        <label class="filter-checkbox-label">
                            <input type="checkbox" name="snaga" value="3001-9999"> Preko 3000 W
                        </label>
                    </div>
                </div>

                <div class="filter-group">
                    <h3>Tip Ugradnje</h3>
                    <div class="filter-options" id="filterUgradnja">
                        <label class="filter-checkbox-label">
                            <input type="checkbox" name="ugradnja" value="Vertikalna"> Vertikalna
                        </label>
                        <label class="filter-checkbox-label">
                            <input type="checkbox" name="ugradnja" value="Horizontalna"> Horizontalna
                        </label>
                    </div>
                </div>

            </aside>
            
            <div class="products-content">
                
                <div class="catalog-controls">
                    <input type="text" id="searchBar" placeholder="Pretraži po nazivu..." class="search-input">
                    <div class="sort-controls">
                        <label for="sortSelect">Sortiraj po:</label>
                        <select id="sortSelect" class="sort-select">
                            <option value="nameAsc">Naziv (A-Z)</option>
                            <option value="nameDesc">Naziv (Z-A)</option>
                            <option value="zapreminaAsc">Zapremina (rastuće)</option>
                            <option value="zapreminaDesc">Zapremina (opadajuće)</option>
                            <option value="snagaDesc">Snaga (opadajuće)</option>
                        </select>
                    </div>
                </div>

                <div class="products-grid" id="productsGrid">
                </div>
            </div>

        </div> </div>
</section>


<script>
    // Globalna promenljiva za praćenje trenutnih filtera - prazna inicijalno
    let activeFilters = {
        zapremina: [],
        snaga: [],
        ugradnja: []
    };

    document.addEventListener('DOMContentLoaded', () => {
        // 1. POČETNO UČITAVANJE PODATAKA
        // Ključna izmena: Koristimo 'products' jer je JSON u src/_data/products.json
        let allProducts;
        try {
            // Nunjucks renderuje sadržaj products.json kao JSON string
            allProducts = JSON.parse('{{ products | dump | safe }}');
            
            if (!Array.isArray(allProducts) || allProducts.length === 0) {
                 console.warn("Proizvodi su prazni. Proverite sadržaj src/_data/products.json.");
                 allProducts = []; 
            }
        } catch (e) {
            console.error("KRITIČNA GREŠKA: JSON parsovanje Nunjucks promenljive 'products' nije uspelo. Detalji:", e);
            allProducts = []; 
        }
        
        // Dohvatanje DOM elemenata
        const productsGrid = document.getElementById('productsGrid');
        const searchBar = document.getElementById('searchBar');
        const sortSelect = document.getElementById('sortSelect');
        const filterSidebar = document.querySelector('.filter-sidebar');

        // Uklanjanje nepostojećih opcija za sortiranje (Cena)
        const priceOptions = ['priceAsc', 'priceDesc'];
        Array.from(sortSelect.options).forEach(option => {
            if (priceOptions.includes(option.value)) {
                option.remove();
            }
        });

        // Pomoćna funkcija za parsovanje opsega (npr. "51-100" -> [51, 100])
        const parseRange = (rangeString) => {
            const parts = rangeString.split('-');
            return [parseInt(parts[0]), parseInt(parts[1]) || Infinity];
        };

        // Funkcija za renderovanje pojedinačne kartice
        const createProductCard = (item) => {
            const card = document.createElement('div');
            card.className = 'product-card';
            
            // Postavljanje data atributa za bržu manipulaciju/debug
            card.setAttribute('data-name', item.naziv.toLowerCase());
            card.setAttribute('data-zapremina', item.zapremina);
            card.setAttribute('data-snaga', item.specifikacije ? item.specifikacije["Snaga grejača (W)"] : null); // Sigurnosna provera
            card.setAttribute('data-ugradnja', item.tip_ugradnje);

            // Ažuriranje prikaza detalja proizvoda
            const zapreminaText = item.zapremina === 'Nema' || isNaN(item.zapremina) ? 'Protočni' : `${item.zapremina} L`;
            const snagaText = item.specifikacije && item.specifikacije["Snaga grejača (W)"] ? `${item.specifikacije["Snaga grejača (W)"]} W` : 'N/A';

            card.innerHTML = `
                <a href="/proizvodi/${item.id}/" class="product-link">
                    <div class="product-image-wrapper">
                        <img src="${item.slika}" alt="${item.naziv}" class="product-img">
                    </div>
                    <div class="product-details">
                        <h3 class="product-name">${item.naziv}</h3>
                        <p class="product-info">Zapremina: <b>${zapreminaText}</b></p>
                        <p class="product-info">Snaga: <b>${snagaText}</b></p>
                        <button class="view-details-btn">Pogledaj detalje</button>
                    </div>
                </a>
            `;
            return card;
        };

        // Funkcija za sortiranje
        const sortProducts = (products, criteria) => {
             switch (criteria) {
                case 'nameAsc':
                    return products.sort((a, b) => a.naziv.localeCompare(b.naziv));
                case 'nameDesc':
                    return products.sort((a, b) => b.naziv.localeCompare(a.naziv));
                case 'zapreminaAsc':
                    return products.sort((a, b) => a.zapremina - b.zapremina);
                case 'zapreminaDesc':
                    return products.sort((a, b) => b.zapremina - a.zapremina);
                case 'snagaDesc':
                    // Koristimo 0 kao fallback za proizvode bez snage (protočni, itd.)
                    return products.sort((a, b) => (b.specifikacije["Snaga grejača (W)"] || 0) - (a.specifikacije["Snaga grejača (W)"] || 0));
                default:
                    return products;
            }
        };

        // GLAVNA FUNKCIJA ZA FILTRIRANJE
        const applyFilters = (product) => {
            
            // 1. Pretraga po nazivu
            const searchTerm = searchBar.value.toLowerCase();
            if (!product.naziv.toLowerCase().includes(searchTerm)) {
                return false;
            }

            // 2. Filtriranje po zapremini
            if (activeFilters.zapremina.length > 0) {
                const zapremina = product.zapremina;
                let zapreminaMatch = false;

                if (zapremina !== 'Nema' && !isNaN(zapremina)) {
                    for (const range of activeFilters.zapremina) {
                        const [min, max] = parseRange(range);
                        if (zapremina >= min && zapremina <= max) {
                            zapreminaMatch = true;
                            break;
                        }
                    }
                }
                if (!zapreminaMatch) return false;
            }


            // 3. Filtriranje po snazi
            if (activeFilters.snaga.length > 0) {
                const snaga = product.specifikacije && product.specifikacije["Snaga grejača (W)"];
                let snagaMatch = false;

                if (snaga) {
                    for (const range of activeFilters.snaga) {
                        const [min, max] = parseRange(range);
                        if (snaga >= min && snaga <= max) {
                            snagaMatch = true;
                            break;
                        }
                    }
                }
                if (!snagaMatch) return false;
            }


            // 4. Filtriranje po tipu ugradnje
            if (activeFilters.ugradnja.length > 0) {
                const ugradnja = product.tip_ugradnje;
                // Proveravamo da li je neka od izabranih vrednosti sadržana u ugradnji (Vertikalna, Horizontalna, Vertikalna (Slim)...)
                const ugradnjaMatch = activeFilters.ugradnja.some(filterVal => ugradnja.toLowerCase().includes(filterVal.toLowerCase()));
                
                if (!ugradnjaMatch) return false;
            }


            return true; // Prošao sve filtere
        };


        // Glavna funkcija za filtriranje i renderovanje
        const updateCatalog = () => {
            const sortValue = sortSelect.value;

            // 1. Filtriranje
            const filteredProducts = allProducts.filter(applyFilters);

            // 2. Sortiranje
            const sortedProducts = sortProducts(filteredProducts, sortValue);

            // 3. Renderovanje
            productsGrid.innerHTML = '';
            
            if (sortedProducts.length === 0) {
                productsGrid.innerHTML = '<p class="no-results">Nema pronađenih proizvoda koji odgovaraju Vašem izboru.</p>';
                productsGrid.style.display = 'block';
            } else {
                sortedProducts.forEach(item => {
                    productsGrid.appendChild(createProductCard(item));
                });
                productsGrid.style.display = 'grid';
            }
        };

        // 4. Postavljanje Event Listeners
        searchBar.addEventListener('input', updateCatalog);
        sortSelect.addEventListener('change', updateCatalog);

        // Event Listener za Filter Sidebar
        filterSidebar.addEventListener('change', (e) => {
            if (e.target.type === 'checkbox') {
                const filterType = e.target.name; 
                const filterValue = e.target.value;

                // Ažuriranje globalnog activeFilters objekta
                if (e.target.checked) {
                    if (!activeFilters[filterType].includes(filterValue)) {
                        activeFilters[filterType].push(filterValue);
                    }
                } else {
                    activeFilters[filterType] = activeFilters[filterType].filter(val => val !== filterValue);
                }
                
                updateCatalog();
            }
        });

        // Inicijalno učitavanje kataloga
        updateCatalog();
    });
</script>